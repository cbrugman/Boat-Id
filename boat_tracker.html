<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lake Erie Boat Tracker</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-color: #0ea5e9;
            --bg-color: #f8fafc;
            --sidebar-width: 380px;
            /* Slight increase */
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            background-color: var(--bg-color);
            overflow: hidden;
        }

        #sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 6px -1px rgb(0 0 0 / 0.05);
            z-index: 1000;
        }

        #map {
            flex-grow: 1;
            height: 100%;
            z-index: 1;
        }

        .header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            background: white;
        }

        .header h1 {
            margin: 0;
            font-size: 1.25rem;
            color: #0f172a;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            background-color: #f1f5f9;
            color: #64748b;
            margin-top: 0.5rem;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            font-weight: 500;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #cbd5e1;
        }

        .status-active .status-dot {
            background-color: #22c55e;
        }

        .status-active {
            background-color: #dcfce7;
            color: #166534;
        }

        .status-error .status-dot {
            background-color: #ef4444;
        }

        .status-error {
            background-color: #fee2e2;
            color: #991b1b;
        }

        #boat-list {
            overflow-y: auto;
            flex-grow: 1;
        }

        .boat-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        @media (hover: hover) {
            .boat-item:hover {
                background-color: #f8fafc;
            }
        }

        .boat-item.selected {
            background-color: #e0f2fe;
            border-left: 3px solid var(--primary-color);
        }

        .boat-name {
            font-weight: 600;
            color: #334155;
            margin-bottom: 0.25rem;
            display: block;
        }

        .boat-details {
            font-size: 0.875rem;
            color: #64748b;
            display: flex;
            gap: 1rem;
        }

        .boat-icon {
            color: #94a3b8;
            margin-right: 0.5rem;
        }

        /* Map controls customization */
        .leaflet-popup-content-wrapper {
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        .popup-content h3 {
            margin: 0 0 0.5rem 0;
            color: #0f172a;
        }

        .popup-btn {
            display: inline-block;
            margin-top: 0.75rem;
            padding: 0.375rem 0.75rem;
            background-color: var(--primary-color);
            color: white;
            text-decoration: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: background-color 0.2s;
        }

        .popup-btn:hover {
            background-color: #0284c7;
        }

        .settings-area {
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .api-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            box-sizing: border-box;
        }

        /* Marker rotation */
        .ship-marker {
            transition: transform 1s linear;
        }

        /* --- Mobile / Responsive Styles --- */
        @media (max-width: 768px) {
            body {
                flex-direction: column-reverse;
                /* Stack: Map on top (technically behind), List on bottom */
                position: relative;
            }

            #sidebar {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 40vh;
                /* Default collapsed height */
                max-height: 80vh;
                min-height: 120px;
                /* Min height for header */
                background: white;
                z-index: 2000;
                border-right: none;
                border-top: 1px solid #e2e8f0;
                border-radius: 16px 16px 0 0;
                box-shadow: 0 -4px 6px -1px rgb(0 0 0 / 0.1);
                transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                display: flex;
                flex-direction: column;
                overflow: hidden;
                /* Prevent body scroll */
            }

            /* Sheet Handle */
            #sidebar::before {
                content: '';
                display: block;
                width: 40px;
                height: 5px;
                background-color: #cbd5e1;
                border-radius: 3px;
                margin: 8px auto;
                flex-shrink: 0;
            }

            #map {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 1;
            }

            /* Adjust controls position so they aren't covered by sheet */
            .leaflet-bottom {
                bottom: 140px !important;
                /* Push scale/attribution up */
            }

            /* Mobile Header compact */
            .header {
                padding: 0.75rem 1.5rem;
                cursor: pointer;
                /* Tap to expand */
            }

            .header h1 {
                font-size: 1rem;
            }

            /* Hide list content when collapsed (optional, but height handles it) */
            /* But we want to scroll the list when expanded */
            #boat-list {
                overscroll-behavior: contain;
                padding-bottom: 20px;
                /* Safe area */
            }

            /* State classes for sheet */
            #sidebar.sheet-expanded {
                height: 80vh;
            }

            #sidebar.sheet-collapsed {
                height: 120px;
                /* Only show header */
            }
        }
    </style>
</head>

<body>

    <div id="sidebar">
        <div class="header">
            <h1><i class="fa-solid fa-anchor" style="color: var(--primary-color);"></i> Lake Erie Watch</h1>
            <div id="connection-status" class="status-badge">
                <span class="status-dot"></span> <span id="status-text">Disconnected</span>
            </div>
        </div>

        <div id="boat-list">
            <div style="padding: 2rem; text-align: center; color: #94a3b8;">
                Waiting for AIS signal...
            </div>
        </div>

    </div>


    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // --- Configuration ---
        const HOME_COORDS = [42.8736833, -79.3324094]; // Updated Location
        const MAP_CENTER = [42.800397, -79.322545]; // Custom Map Center

        // Bounding box for "Nearby" filter (approx Eastern Lake Erie & Canal entrance)
        const BOUNDS = {
            north: 43.0,
            south: 42.60,
            west: -79.60,
            east: -78.90
        };

        // --- State ---
        let map;
        let socket;
        let vessels = {}; // Store vessel data objects
        let markers = {}; // Store Leaflet marker objects
        let selectedMmsi = null;
        let demoInterval = null;

        // --- Initialization ---
        function initMap() {
            map = L.map('map').setView(MAP_CENTER, 11);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            // Add a marker for "Home Base" (approx)
            const homeIcon = L.divIcon({
                html: '<i class="fa-solid fa-house" style="color: #ef4444; font-size: 20px;"></i>',
                className: 'home-marker',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            L.marker(HOME_COORDS, { icon: homeIcon }).addTo(map).bindPopup("<b>Sunset Bay View</b>");


            startStream();
        }

        function updateStatus(connected, msg, isError = false) {
            const el = document.getElementById('connection-status');
            const txt = document.getElementById('status-text');
            txt.innerText = msg;

            if (connected) {
                el.className = 'status-badge status-active';
            } else if (isError) {
                el.className = 'status-badge status-error';
            } else {
                el.className = 'status-badge';
                el.style.backgroundColor = '#f1f5f9';
                el.style.color = '#64748b';
            }
        }

        function startStream() {
            stopDemo();
            if (socket) {
                socket.close();
            }

            updateStatus(false, "Connecting to Boat ID Server...");

            // Try Render first, then Localhost
            const WS_URLS = [
                "wss://boat-id.onrender.com",
                "ws://localhost:8765"
            ];

            function tryConnect(index) {
                if (index >= WS_URLS.length) {
                    updateStatus(false, "Connection Failed - Is Server Running?", true);
                    return;
                }

                const url = WS_URLS[index];
                console.log("Trying connection to:", url);

                try {
                    socket = new WebSocket(url);
                } catch (e) {
                    tryConnect(index + 1);
                    return;
                }

                socket.onopen = function (event) {
                    console.log("Connected to:", url);
                    updateStatus(true, "Connected -> Authenticating...");

                    // Subscription message (API Key injected by Server now)
                    const subscription = {
                        BoundingBoxes: [[
                            [BOUNDS.south, BOUNDS.west],
                            [BOUNDS.north, BOUNDS.east]
                        ]],
                        FilterMessageTypes: ["PositionReport", "ShipStaticData"]
                    };
                    socket.send(JSON.stringify(subscription));
                };

                socket.onmessage = function (event) {
                    // If we get data, we are good!
                    if (document.getElementById('status-text').innerText.includes("Authenticating")) {
                        updateStatus(true, "Live Streaming");
                    }

                    const message = JSON.parse(event.data);
                    if (message.MessageType === "PositionReport") {
                        handlePositionReport(message);
                    } else if (message.MessageType === "ShipStaticData") {
                        handleStaticData(message);
                    }
                };

                socket.onclose = function (event) {
                    console.log("Closed connection to:", url);
                    // If this connection fails/closes, try the next one ONLY if we were never fully connected?
                    // Or just let the user retry. For simplicity, if it closes immediately, we might want to try next.
                    // But here, if onclose happens after a successful connection, it's just a disconnect.
                    // If it happens immediately (before "Live Streaming"), it might be a failure.

                    if (!document.getElementById('status-text').innerText.includes("Live Streaming")) {
                        // Likely failed to connect or handshake
                        tryConnect(index + 1);
                    } else {
                        updateStatus(false, "Disconnected", true);
                    }
                };

                socket.onerror = function (error) {
                    console.error("WebSocket Error on " + url, error);
                    // onError usually precedes onClose, so let onClose handle the retry logic
                };
            }

            tryConnect(0);
        }

        // --- Demo Mode ---
        function startDemo() {
            if (socket) socket.close();
            updateStatus(true, "Demo Mode Active");

            // Create some fake vessels
            const demoShips = [
                { mmsi: 123456789, name: "Lake Freighter (Demo)", lat: 42.85, lon: -79.30, cog: 90, sog: 12.5 },
                { mmsi: 987654321, name: "Fishing Boat (Demo)", lat: 42.82, lon: -79.20, cog: 270, sog: 5.2 },
                { mmsi: 112233445, name: "Cargo Carrier (Demo)", lat: 42.95, lon: -79.26, cog: 180, sog: 10.0 }
            ];

            // Initial Draw
            demoShips.forEach(s => {
                vessels[s.mmsi] = { ...s, lastUpdate: Date.now() };
                updateMarker(s.mmsi);
            });
            updateList();

            // Animate them
            demoInterval = setInterval(() => {
                demoShips.forEach(s => {
                    // Move slightly based on COG
                    s.lat += (Math.random() - 0.5) * 0.005;
                    s.lon += (Math.random() - 0.5) * 0.005;
                    s.cog = (s.cog + 5) % 360;

                    vessels[s.mmsi] = { ...s, lastUpdate: Date.now() };
                    updateMarker(s.mmsi);
                });
                updateList();
            }, 2000);
        }

        function stopDemo() {
            if (demoInterval) clearInterval(demoInterval);
            demoInterval = null;
        }

        function handlePositionReport(msg) {
            const mmsi = msg.MetaData.MMSI;
            const lat = msg.Message.PositionReport.Latitude;
            const lon = msg.Message.PositionReport.Longitude;
            const cog = msg.Message.PositionReport.Cog; // Course over ground
            const sog = msg.Message.PositionReport.Sog; // Speed over ground

            if (!vessels[mmsi]) {
                vessels[mmsi] = {
                    mmsi: mmsi,
                    name: `Vessel ${mmsi}`,
                    type: 'Unknown',
                    lastUpdate: Date.now()
                };
            }

            vessels[mmsi].lat = lat;
            vessels[mmsi].lon = lon;
            vessels[mmsi].cog = cog;
            vessels[mmsi].sog = sog;
            vessels[mmsi].lastUpdate = Date.now();

            // Optimization: Use name from MetaData if available (faster than waiting for StaticData)
            if (msg.MetaData.ShipName) {
                vessels[mmsi].name = msg.MetaData.ShipName.trim();
            }

            updateMarker(mmsi);
            updateList();
        }

        function handleStaticData(msg) {
            const mmsi = msg.MetaData.MMSI;
            const data = msg.Message.ShipStaticData;

            if (!vessels[mmsi]) {
                vessels[mmsi] = {
                    mmsi: mmsi,
                    lat: 0, lon: 0,
                    lastUpdate: Date.now()
                };
            }

            // Clean strings
            vessels[mmsi].name = (data.Name || "").replace(/@+$/, '').trim();
            vessels[mmsi].type = data.Type;

            // New Fields
            vessels[mmsi].destination = (data.Destination || "").replace(/@+$/, '').trim();
            vessels[mmsi].draught = data.MaximumStaticDraught || 0;

            // Length = A + B (Distance from GPS to Bow + Stern)
            if (data.Dimension) {
                vessels[mmsi].length = (data.Dimension.A || 0) + (data.Dimension.B || 0);
                vessels[mmsi].width = (data.Dimension.C || 0) + (data.Dimension.D || 0);
            }

            updateMarker(mmsi);
            updateList();
        }

        function getShipIcon(cog) {
            // Custom SVG boat shape (Top-down view)
            // More distinct "Ship" shape: Pointed bow, straight sides, flat stern
            return L.divIcon({
                html: `
                    <svg viewBox="0 0 24 24" width="24" height="24" style="transform: rotate(${cog}deg); filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); overflow:visible;">
                        <!-- Ship Hull: Pointed bow, straight body, flat rear -->
                        <path d="M12 1 C12 1 19 6 19 10 V22 H5 V10 C5 6 12 1 12 1 Z" fill="#0ea5e9" stroke="white" stroke-width="2"/>
                        <!-- Bridge/Cabin Rect -->
                        <rect x="7" y="16" width="10" height="4" rx="1" fill="white" fill-opacity="0.5"/>
                    </svg>
                `,
                className: 'ship-marker',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
        }

        function updateMarker(mmsi) {
            const v = vessels[mmsi];

            // If valid position
            if (v.lat === 0 && v.lon === 0) return;

            if (!markers[mmsi]) {
                markers[mmsi] = L.marker([v.lat, v.lon], {
                    icon: getShipIcon(v.cog || 0)
                }).addTo(map);

                markers[mmsi].on('click', () => {
                    selectVessel(mmsi);
                });
            } else {
                markers[mmsi].setLatLng([v.lat, v.lon]);
                markers[mmsi].setIcon(getShipIcon(v.cog || 0));
            }

            // Update popup content if it's already bound
            const popupContent = generatePopupContent(v);
            if (markers[mmsi].getPopup()) {
                markers[mmsi].setPopupContent(popupContent);
            } else {
                markers[mmsi].bindPopup(popupContent);
            }

            // --- Tooltip Logic with Pre-Check ---
            const imgUrl = `https://photos.marinetraffic.com/ais/showphoto.aspx?mmsi=${v.mmsi}`;

            // Only update tooltip content if we haven't determined image status yet OR it changed
            if (v.imageStatus === undefined) {
                // Initial State: Show name only, check image in background
                setTooltipContent(markers[mmsi], v.name, null);

                v.imageStatus = 'checking'; // Prevent multiple checks
                const img = new Image();
                img.onload = function () {
                    v.imageStatus = 'found';
                    setTooltipContent(markers[mmsi], v.name, imgUrl); // Update with image
                };
                img.onerror = function () {
                    v.imageStatus = 'missing';
                    // No update needed, already showing text only
                };
                img.src = imgUrl;

            } else if (v.imageStatus === 'found') {
                // We know image is good
                setTooltipContent(markers[mmsi], v.name, imgUrl);
            } else if (v.imageStatus === 'missing') {
                // We know image is bad
                setTooltipContent(markers[mmsi], v.name, null);
            }
        }

        function setTooltipContent(marker, name, imgUrl) {
            let content = '';
            if (imgUrl) {
                content = `
                    <div style="text-align:center;">
                        <img src="${imgUrl}" style="width:120px; height:80px; object-fit:cover; border-radius:4px; margin-bottom:4px; display:block;">
                        <b>${name}</b>
                    </div>
                `;
            } else {
                content = `<div style="text-align:center;"><b>${name}</b></div>`;
            }

            if (marker.getTooltip()) {
                // Only update if content is different to avoid flicker? 
                // Leaflet handles this okay usually.
                if (marker.getTooltip().getContent() !== content) {
                    marker.setTooltipContent(content);
                }
            } else {
                marker.bindTooltip(content, {
                    direction: 'top',
                    offset: [0, -15],
                    className: 'custom-tooltip',
                    opacity: 1
                });
            }
        }

        function generatePopupContent(v) {
            const imgUrl = `https://photos.marinetraffic.com/ais/showphoto.aspx?mmsi=${v.mmsi}`;
            // Same simple layout as the tooltip
            return `
                <div class="popup-content" style="text-align:center;">
                    <img src="${imgUrl}" style="width:150px; height:100px; object-fit:cover; border-radius:4px; margin-bottom:0.5rem; display:block; margin-left:auto; margin-right:auto;" onerror="this.style.display='none'">
                    <h3>${v.name}</h3>
                    <div style="font-size:0.9em; color:#64748b;">
                        <i class="fa-solid fa-gauge-high"></i> ${v.sog ? v.sog.toFixed(1) : 0} kn
                        <span style="margin: 0 0.5rem">|</span>
                        <i class="fa-solid fa-compass"></i> ${v.cog ? v.cog.toFixed(0) : 0}Â°
                    </div>
                </div>
            `;
        }

        function selectVessel(mmsi) {
            selectedMmsi = mmsi;

            // Explicitly close tooltip to avoid UI conflict/overlap
            if (markers[mmsi]) {
                markers[mmsi].closeTooltip();
                markers[mmsi].openPopup();
            }

            updateList(true); // Force update to show highlight immediately

            // Scroll list to selected item
            const listEl = document.getElementById('boat-list');
            // We need to wait for the DOM to update from updateList
            setTimeout(() => {
                const selectedEl = listEl.querySelector('.boat-item.selected');
                if (selectedEl) {
                    selectedEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 50);

            // Mobile: Collapse sheet to show map
            collapseSheet();
        }

        // --- Helpers ---
        function getDistance(lat, lon) {
            return map.distance(HOME_COORDS, [lat, lon]);
        }

        function formatDistance(meters) {
            const km = meters / 1000;
            return meters / 1000 < 100 ? (meters / 1000).toFixed(1) + " km" : (meters / 1000).toFixed(0) + " km";
        }

        function getCountryFlag(mmsi) {
            const mid = parseInt(mmsi.toString().substring(0, 3));
            let code = "unknown";
            let name = "Unknown Galaxy";

            // Common Lake Erie Flags -> ISO Codes
            if (mid === 316) { code = "ca"; name = "Canada"; }
            else if (mid >= 366 && mid <= 369) { code = "us"; name = "USA"; }
            else if (mid === 338) { code = "us"; name = "USA"; }
            else if (mid === 303) { code = "us"; name = "USA"; }
            else if (mid === 538) { code = "mh"; name = "Marshall Islands"; }
            else if (mid === 636) { code = "lr"; name = "Liberia"; }
            else if (mid >= 351 && mid <= 357) { code = "pa"; name = "Panama"; }
            else if (mid >= 232 && mid <= 235) { code = "gb"; name = "UK"; }
            else if (mid === 244) { code = "nl"; name = "Netherlands"; }
            else if (mid === 257) { code = "no"; name = "Norway"; }
            else if (mid === 477) { code = "hk"; name = "Hong Kong"; }
            else if (mid === 209 || mid === 210 || mid === 212) { code = "cy"; name = "Cyprus"; }
            else if (mid === 248 || mid === 249) { code = "mt"; name = "Malta"; }
            else if (mid === 304 || mid === 305) { code = "ag"; name = "Antigua"; }
            else if (mid === 255) { code = "pt"; name = "Portugal"; }
            else if (mid === 311) { code = "bs"; name = "Bahamas"; }

            return { code, name };
        }

        // AIS Ship Type to Icon mapping
        function getShipTypeIcon(typeCode) {
            // Default generic
            let icon = "fa-ship";

            // Simplified mapping
            // 30=Fishing, 52=Tug, 60-69=Passenger, 70-79=Cargo, 80-89=Tanker, 36-37=Pleasure
            if (typeCode == 30) icon = "fa-fish";
            else if (typeCode == 52) icon = "fa-anchor"; // Tug
            else if (typeCode >= 60 && typeCode <= 69) icon = "fa-person-swimming"; // Passenger/Ferry (approx)
            else if (typeCode >= 80 && typeCode <= 89) icon = "fa-oil-can"; // Tanker (approx)
            else if (typeCode == 36 || typeCode == 37) icon = "fa-sailboat"; // Pleasure

            return icon;
        }

        function highlightBoat(mmsi) {
            const marker = markers[mmsi];
            if (marker) {
                // simple visual highlight
                marker._icon.style.filter = "hue-rotate(150deg) drop-shadow(0 0 5px rgba(0,0,0,0.5))";
                marker._icon.style.zIndex = 10000;

                // Show existing tooltip if available
                if (marker.getTooltip() && !marker.getPopup().isOpen()) {
                    marker.openTooltip();
                }
            }
        }

        function unhighlightBoat(mmsi) {
            const marker = markers[mmsi];
            if (marker) {
                marker._icon.style.filter = "";
                marker._icon.style.zIndex = "auto";
                marker.closeTooltip();
                // Do NOT unbind - keeps the main tooltip ready for map hover
            }
        }

        // --- Mobile Sheet Logic ---
        function toggleSheet() {
            const sidebar = document.getElementById('sidebar');
            // Only toggle on mobile
            if (window.innerWidth > 768) return;

            if (sidebar.classList.contains('sheet-expanded')) {
                sidebar.classList.remove('sheet-expanded');
                sidebar.classList.add('sheet-collapsed');
            } else {
                sidebar.classList.remove('sheet-collapsed');
                sidebar.classList.add('sheet-expanded');
            }
        }

        function collapseSheet() {
            const sidebar = document.getElementById('sidebar');
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('sheet-expanded');
                sidebar.classList.add('sheet-collapsed');
            }
        }

        // --- Swipe Gestures ---
        let touchStartY = 0;

        document.addEventListener('DOMContentLoaded', () => {
            const header = document.querySelector('.header');
            if (header) {
                header.addEventListener('click', toggleSheet);
            }

            // Swipe Logic
            const sidebar = document.getElementById('sidebar');
            const listEl = document.getElementById('boat-list');

            if (sidebar) {
                sidebar.addEventListener('touchstart', (e) => {
                    touchStartY = e.touches[0].clientY;
                }, { passive: true });

                sidebar.addEventListener('touchend', (e) => {
                    const touchEndY = e.changedTouches[0].clientY;
                    const diff = touchStartY - touchEndY;

                    if (Math.abs(diff) < 50) return; // Ignore small swipes

                    // Only enable on mobile
                    if (window.innerWidth > 768) return;

                    if (diff > 0) {
                        // Swipe UP -> Expand
                        if (!sidebar.classList.contains('sheet-expanded')) {
                            sidebar.classList.remove('sheet-collapsed');
                            sidebar.classList.add('sheet-expanded');
                        }
                    } else {
                        // Swipe DOWN -> Collapse
                        // Only if we are at the top of the list (scrolled to top)
                        // This prevents collapsing while trying to scroll up the list content
                        if (listEl && listEl.scrollTop === 0) {
                            sidebar.classList.remove('sheet-expanded');
                            sidebar.classList.add('sheet-collapsed');
                        }
                    }
                }, { passive: true });
            }
        });

        let lastListUpdate = 0;
        function updateList(force = false) {
            // Rate limit list DOM updates slightly, unless forced
            const now = Date.now();
            if (!force && now - lastListUpdate < 1000) return;
            lastListUpdate = now;

            const listEl = document.getElementById('boat-list');
            const shipKeys = Object.keys(vessels);

            if (shipKeys.length === 0) {
                if (document.getElementById('status-text').innerText.includes("Demo")) {
                    listEl.innerHTML = '<div style="padding: 2rem; text-align: center; color: #94a3b8;">Starting Demo...</div>';
                } else {
                    listEl.innerHTML = '<div style="padding: 2rem; text-align: center; color: #94a3b8;">Waiting for AIS signal...</div>';
                }
                return;
            }

            // Calculate distances for sorting
            shipKeys.forEach(k => {
                vessels[k].distance = getDistance(vessels[k].lat, vessels[k].lon);
            });

            // Sort by DISTANCE (closest first)
            shipKeys.sort((a, b) => vessels[a].distance - vessels[b].distance);

            let html = '';
            shipKeys.forEach(key => {
                const v = vessels[key];
                // Only show if we have a position
                if (v.lat === 0) return;

                const isSelected = selectedMmsi == key ? 'selected' : '';
                const typeIcon = getShipTypeIcon(v.type);
                const distStr = formatDistance(v.distance);
                const { code, name: countryName } = getCountryFlag(v.mmsi);

                // Flag Image HTML
                const flagHtml = code !== 'unknown'
                    ? `<img src="https://flagcdn.com/20x15/${code}.png" style="vertical-align: text-top; margin-right:4px;" alt="${countryName}">`
                    : `<i class="fa-regular fa-flag" style="margin-right:4px;"></i>`;

                // Format Dimensions
                const dims = v.length ? `${v.length}m` : '';
                const draught = v.draught ? `Draft: ${v.draught.toFixed(1)}m` : '';
                const dest = v.destination ? `To: ${v.destination}` : '';

                html += `
                    <div class="boat-item ${isSelected}" 
                         onclick="selectVessel('${v.mmsi}')"
                         onmouseenter="highlightBoat('${v.mmsi}')"
                         onmouseleave="unhighlightBoat('${v.mmsi}')">
                         
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <div>
                                <span class="boat-name">${flagHtml} ${v.name}</span>
                                <div style="font-size:0.75rem; color:#64748b; margin-top:2px;">${countryName}</div>
                                ${dest ? `<div style="font-size:0.75rem; color:#64748b; margin-top:1px;">${dest}</div>` : ''}
                            </div>
                            <span style="font-size:0.75rem; color:#64748b; background:#f1f5f9; padding:2px 6px; border-radius:4px; white-space:nowrap;">${distStr}</span>
                        </div>
                        
                        <div class="boat-details" style="margin-top:0.5rem;">
                            <span><i class="fa-solid fa-gauge boat-icon"></i>${v.sog ? v.sog.toFixed(1) : 0}kn</span>
                            ${dims ? `<span><i class="fa-solid fa-ruler-horizontal boat-icon"></i>${dims}</span>` : ''}
                            ${draught ? `<span><i class="fa-solid fa-water boat-icon"></i>${v.draught.toFixed(1)}m</span>` : ''}
                        </div>

                         <div style="margin-top:0.5rem; display:flex; gap:0.5rem;">
                            <a href="https://www.marinetraffic.com/en/ais/details/ships/mmsi:${v.mmsi}" 
                               target="_blank" 
                               onclick="event.stopPropagation()"
                               style="flex:1; text-align:center; padding:4px; background:#0ea5e9; color:white; border-radius:4px; font-size:0.75rem; text-decoration:none;">
                               <i class="fa-solid fa-images"></i> MarineTraffic
                            </a>
                            <a href="https://www.vesselfinder.com/vessels/details/${v.mmsi}" 
                               target="_blank" 
                               onclick="event.stopPropagation()"
                               style="flex:1; text-align:center; padding:4px; background:#3b82f6; color:white; border-radius:4px; font-size:0.75rem; text-decoration:none;">
                               <i class="fa-solid fa-magnifying-glass"></i> VesselFinder
                            </a>
                        </div>
                    </div>
                `;
            });

            listEl.innerHTML = html;
        }

        // Cleanup old vessels every minute
        setInterval(() => {
            const now = Date.now();
            Object.keys(vessels).forEach(key => {
                // Remove if no update for 10 minutes
                if (now - vessels[key].lastUpdate > 10 * 60 * 1000) {
                    if (markers[key]) {
                        map.removeLayer(markers[key]);
                        delete markers[key];
                    }
                    delete vessels[key];
                }
            });
            updateList();
        }, 60000);

        // Run
        window.addEventListener('DOMContentLoaded', initMap);

    </script>
</body>

</html>